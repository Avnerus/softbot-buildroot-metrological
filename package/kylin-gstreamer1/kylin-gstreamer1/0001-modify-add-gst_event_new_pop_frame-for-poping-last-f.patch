From f085ccb0bf1998136da570d91c574ec1a7776dad Mon Sep 17 00:00:00 2001
From: yaozenhu <yaozenhu@realtek.com>
Date: Wed, 1 Mar 2017 10:33:53 +0000
Subject: [PATCH 1/7] [modify] add gst_event_new_pop_frame for poping last
 frame on rtkv1sink [reviewer] Paul

Change-Id: Iafd49b967af8c03c016b0e82bcb88d0372681886
---
 gst/gstevent.c | 12 +++++++++++-
 gst/gstevent.h |  7 +++++--
 2 files changed, 16 insertions(+), 3 deletions(-)

diff --git a/gst/gstevent.c b/gst/gstevent.c
index e0e0ea6..3d2006b 100644
--- a/gst/gstevent.c
+++ b/gst/gstevent.c
@@ -128,7 +128,7 @@ static GstEventQuarks event_quarks[] = {
   {GST_EVENT_CUSTOM_DOWNSTREAM_STICKY, "custom-downstream-sticky", 0},
   {GST_EVENT_CUSTOM_BOTH, "custom-both", 0},
   {GST_EVENT_CUSTOM_BOTH_OOB, "custom-both-oob", 0},
-
+  {GST_EVENT_CUSTOM_POP_FRAME, "custom-pop-frame", 0},
   {0, NULL, 0}
 };
 
@@ -554,6 +554,16 @@ gst_event_new_flush_stop (gboolean reset_time)
 }
 
 /**
+ * Allocate a new pop frame event. The event will let rtkv1sink return last frame back to gst-omx
+ * Returns : (transfer full): a new pop frame event.
+ */
+GstEvent *
+gst_event_new_pop_frame (void)
+{
+  return gst_event_new_custom (GST_EVENT_CUSTOM_POP_FRAME, NULL);
+}
+
+/**
  * gst_event_parse_flush_stop:
  * @event: The event to parse
  * @reset_time: (out): if time should be reset
diff --git a/gst/gstevent.h b/gst/gstevent.h
index e20c820..020a1f2 100644
--- a/gst/gstevent.h
+++ b/gst/gstevent.h
@@ -170,7 +170,8 @@ typedef enum {
   GST_EVENT_CUSTOM_DOWNSTREAM_OOB    = GST_EVENT_MAKE_TYPE (290, FLAG(DOWNSTREAM)),
   GST_EVENT_CUSTOM_DOWNSTREAM_STICKY = GST_EVENT_MAKE_TYPE (300, FLAG(DOWNSTREAM) | FLAG(SERIALIZED) | FLAG(STICKY) | FLAG(STICKY_MULTI)),
   GST_EVENT_CUSTOM_BOTH              = GST_EVENT_MAKE_TYPE (310, FLAG(BOTH) | FLAG(SERIALIZED)),
-  GST_EVENT_CUSTOM_BOTH_OOB          = GST_EVENT_MAKE_TYPE (320, FLAG(BOTH))
+  GST_EVENT_CUSTOM_BOTH_OOB          = GST_EVENT_MAKE_TYPE (320, FLAG(BOTH)),
+  GST_EVENT_CUSTOM_POP_FRAME         = GST_EVENT_MAKE_TYPE (330, FLAG(DOWNSTREAM))
 } GstEventType;
 #undef FLAG
 
@@ -476,10 +477,12 @@ gboolean        gst_event_parse_group_id        (GstEvent *event, guint *group_i
 
 /* flush events */
 GstEvent *      gst_event_new_flush_start       (void) G_GNUC_MALLOC;
-
 GstEvent *      gst_event_new_flush_stop        (gboolean reset_time) G_GNUC_MALLOC;
 void            gst_event_parse_flush_stop      (GstEvent *event, gboolean *reset_time);
 
+/* force bubble mode */
+GstEvent *      gst_event_new_pop_frame         (void) G_GNUC_MALLOC;
+
 /* EOS event */
 GstEvent *      gst_event_new_eos               (void) G_GNUC_MALLOC;
 
-- 
2.7.4

