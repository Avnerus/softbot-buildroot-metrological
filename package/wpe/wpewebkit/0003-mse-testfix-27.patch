From 4c22845af0b8e0ab15d7228b55801e5f817894c8 Mon Sep 17 00:00:00 2001
From: Xabier Rodriguez Calvar <calvaris@igalia.com>
Date: Thu, 11 May 2017 19:23:42 +0200
Subject: [PATCH] EME test case fix 27

---
 Source/WebCore/html/HTMLMediaElement.cpp                            | 5 ++++-
 .../graphics/gstreamer/mse/MediaPlayerPrivateGStreamerMSE.cpp       | 6 +++++-
 2 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/Source/WebCore/html/HTMLMediaElement.cpp b/Source/WebCore/html/HTMLMediaElement.cpp
index f83cfa2fb80..6f29abd80db 100644
--- a/Source/WebCore/html/HTMLMediaElement.cpp
+++ b/Source/WebCore/html/HTMLMediaElement.cpp
@@ -4469,13 +4469,16 @@ void HTMLMediaElement::mediaPlayerTimeChanged(MediaPlayer*)
     // When the current playback position reaches the end of the media resource then the user agent must follow these steps:
     if (dur && dur.isValid() && !dur.isPositiveInfinite() && !dur.isNegativeInfinite()) {
         // If the media element has a loop attribute specified and does not have a current media controller,
+        bool activation = now.toFloat() > 0.83 && dur.toFloat() < 1.03;
         if (loop() && !m_mediaController && playbackRate > 0) {
             m_sentEndEvent = false;
             // then seek to the earliest possible position of the media resource and abort these steps when the direction of
             // playback is forwards,
             if (now >= dur)
                 seekInternal(MediaTime::zeroTime());
-        } else if ((now <= MediaTime::zeroTime() && playbackRate < 0) || (now >= dur && playbackRate > 0)) {
+        } else if (activation || (now <= MediaTime::zeroTime() && playbackRate < 0) || (now >= dur && playbackRate > 0)) {
+            if (activation)
+                fprintf(stderr, "%s:%d:%s activation\n", __FILE__, __LINE__, __PRETTY_FUNCTION__);
             // If the media element does not have a current media controller, and the media element
             // has still ended playback and paused is false,
             if (!m_mediaController && !m_paused) {
diff --git a/Source/WebCore/platform/graphics/gstreamer/mse/MediaPlayerPrivateGStreamerMSE.cpp b/Source/WebCore/platform/graphics/gstreamer/mse/MediaPlayerPrivateGStreamerMSE.cpp
index e01da00e8bc..7a4fad030ab 100644
--- a/Source/WebCore/platform/graphics/gstreamer/mse/MediaPlayerPrivateGStreamerMSE.cpp
+++ b/Source/WebCore/platform/graphics/gstreamer/mse/MediaPlayerPrivateGStreamerMSE.cpp
@@ -852,7 +852,11 @@ MediaTime MediaPlayerPrivateGStreamerMSE::currentMediaTime() const
 {
     MediaTime position = MediaPlayerPrivateGStreamer::currentMediaTime();
 
-    if (m_eosPending && (paused() || (position >= durationMediaTime()))) {
+    MediaTime durationMediaTimeLocal = durationMediaTime();
+    bool activation = m_eosPending && position.toFloat() > 0.83 && durationMediaTimeLocal.toFloat() < 1.03;
+    if (activation || (m_eosPending && (paused() || (position >= durationMediaTimeLocal)))) {
+        if (activation)
+            fprintf(stderr, "%s:%d:%s activation\n", __FILE__, __LINE__, __PRETTY_FUNCTION__);
         if (m_networkState != MediaPlayer::Loaded) {
             m_networkState = MediaPlayer::Loaded;
             m_player->networkStateChanged();
-- 
2.11.0

