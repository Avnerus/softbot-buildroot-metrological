From 12d08e9010a7077f5ba6a017137a66497ebcef9f Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Enrique=20Oca=C3=B1a=20Gonz=C3=A1lez?= <eocanha@igalia.com>
Date: Wed, 28 Dec 2016 11:50:10 +0000
Subject: [PATCH 2/6] [GStreamer][MSE] Fusion: Use key unit seek instead of
 accurate seek on Fusion

---
 .../graphics/gstreamer/MediaPlayerPrivateGStreamer.cpp  | 17 ++++++++++++++---
 .../graphics/gstreamer/MediaPlayerPrivateGStreamer.h    |  1 +
 .../gstreamer/MediaPlayerPrivateGStreamerMSE.cpp        |  2 +-
 3 files changed, 16 insertions(+), 4 deletions(-)

diff --git a/Source/WebCore/platform/graphics/gstreamer/MediaPlayerPrivateGStreamer.cpp b/Source/WebCore/platform/graphics/gstreamer/MediaPlayerPrivateGStreamer.cpp
index 22af698..d58a04f 100644
--- a/Source/WebCore/platform/graphics/gstreamer/MediaPlayerPrivateGStreamer.cpp
+++ b/Source/WebCore/platform/graphics/gstreamer/MediaPlayerPrivateGStreamer.cpp
@@ -413,6 +413,17 @@ float MediaPlayerPrivateGStreamer::playbackPosition() const
     return result;
 }
 
+GstSeekFlags MediaPlayerPrivateGStreamer::hardwareDependantSeekFlags()
+{
+#if USE(FUSION_SINK)
+    // With Fusion we use a decoder+renderer sink which can't be fed with samples not starting
+    // in a key frame.
+    return static_cast<GstSeekFlags>(GST_SEEK_FLAG_KEY_UNIT | GST_SEEK_FLAG_SNAP_NEAREST);
+#else
+    return GST_SEEK_FLAG_ACCURATE;
+#endif
+}
+
 void MediaPlayerPrivateGStreamer::readyTimerFired()
 {
     changePipelineState(GST_STATE_NULL);
@@ -602,7 +613,7 @@ void MediaPlayerPrivateGStreamer::seek(float time)
         }
     } else {
         // We can seek now.
-        if (!doSeek(clockTime, m_player->rate(), static_cast<GstSeekFlags>(GST_SEEK_FLAG_FLUSH | GST_SEEK_FLAG_ACCURATE))) {
+        if (!doSeek(clockTime, m_player->rate(), static_cast<GstSeekFlags>(GST_SEEK_FLAG_FLUSH | hardwareDependantSeekFlags()))) {
             LOG_MEDIA_MESSAGE("[Seek] seeking to %f failed", time);
             return;
         }
@@ -661,7 +672,7 @@ void MediaPlayerPrivateGStreamer::updatePlaybackRate()
     }
 
     INFO_MEDIA_MESSAGE("Need to mute audio?: %d", (int) mute);
-    if (doSeek(currentPosition, m_playbackRate, static_cast<GstSeekFlags>(GST_SEEK_FLAG_FLUSH))) {
+    if (doSeek(currentPosition, m_playbackRate, static_cast<GstSeekFlags>(GST_SEEK_FLAG_FLUSH | hardwareDependantSeekFlags()))) {
         g_object_set(m_pipeline.get(), "mute", mute, nullptr);
         m_lastPlaybackRate = m_playbackRate;
     } else {
@@ -1665,7 +1676,7 @@ void MediaPlayerPrivateGStreamer::updateStates()
         if (m_seekIsPending) {
             LOG_MEDIA_MESSAGE("[Seek] committing pending seek to %f", m_seekTime);
             m_seekIsPending = false;
-            m_seeking = doSeek(toGstClockTime(m_seekTime), m_player->rate(), static_cast<GstSeekFlags>(GST_SEEK_FLAG_FLUSH | GST_SEEK_FLAG_ACCURATE));
+            m_seeking = doSeek(toGstClockTime(m_seekTime), m_player->rate(), static_cast<GstSeekFlags>(GST_SEEK_FLAG_FLUSH | hardwareDependantSeekFlags()));
             if (!m_seeking) {
                 m_cachedPosition = -1;
                 LOG_MEDIA_MESSAGE("[Seek] seeking to %f failed", m_seekTime);
diff --git a/Source/WebCore/platform/graphics/gstreamer/MediaPlayerPrivateGStreamer.h b/Source/WebCore/platform/graphics/gstreamer/MediaPlayerPrivateGStreamer.h
index 09d3e24..3f4a583 100644
--- a/Source/WebCore/platform/graphics/gstreamer/MediaPlayerPrivateGStreamer.h
+++ b/Source/WebCore/platform/graphics/gstreamer/MediaPlayerPrivateGStreamer.h
@@ -186,6 +186,7 @@ protected:
     bool m_seekIsPending;
     bool m_volumeAndMuteInitialized;
 
+    static GstSeekFlags hardwareDependantSeekFlags();
     void readyTimerFired();
 
     void notifyPlayerOfVideo();
diff --git a/Source/WebCore/platform/graphics/gstreamer/MediaPlayerPrivateGStreamerMSE.cpp b/Source/WebCore/platform/graphics/gstreamer/MediaPlayerPrivateGStreamerMSE.cpp
index 6ebdb61..33848cb 100644
--- a/Source/WebCore/platform/graphics/gstreamer/MediaPlayerPrivateGStreamerMSE.cpp
+++ b/Source/WebCore/platform/graphics/gstreamer/MediaPlayerPrivateGStreamerMSE.cpp
@@ -399,7 +399,7 @@ bool MediaPlayerPrivateGStreamerMSE::doSeek()
     GstClockTime position = toGstClockTime(m_seekTime);
     MediaTime seekTime = MediaTime::createWithDouble(m_seekTime + MediaTime::FuzzinessThreshold);
     double rate = m_player->rate();
-    GstSeekFlags seekType = static_cast<GstSeekFlags>(GST_SEEK_FLAG_FLUSH | GST_SEEK_FLAG_ACCURATE);
+    GstSeekFlags seekType = static_cast<GstSeekFlags>(GST_SEEK_FLAG_FLUSH | hardwareDependantSeekFlags());
 
     // Always move to seeking state to report correct 'currentTime' while pending for actual seek to complete
     m_seeking = true;
-- 
1.8.3.2

